<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Scénarios TOPSIS – CR vs Architecte</title>

  <!-- Librairies externes -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    .control { margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    select, button, input { margin-left: 10px; }
    #chart { max-width: 600px; margin-top: 30px; }
  </style>
</head>
<body>

  <h1>⚖️ Classement selon scénario d’influence</h1>

  <div class="control">
    <label for="csvFile">Charger les scores (CSV ou Excel) :</label>
    <input type="file" id="csvFile" accept=".csv,.xlsx,.xls">
  </div>

  <div class="control">
    <label for="scenario">Choisir le scénario :</label>
    <select id="scenario">
      <option value="0.25,0.75">CR 25 % – Arch 75 %</option>
      <option value="0.50,0.50" selected>CR 50 % – Arch 50 %</option>
      <option value="0.75,0.25">CR 75 % – Arch 25 %</option>
    </select>
    <button id="runBtn">▶ Calculer</button>
  </div>

  <div id="result"></div>
  <canvas id="chart"></canvas>

  <script>
    const fileInput = document.getElementById('csvFile');
    const runBtn    = document.getElementById('runBtn');
    let data = [];

    // 1) Chargement du fichier (CSV ou Excel)
    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'csv') {
        Papa.parse(file, {
          header: true,
          delimiter: ";",
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: res => {
            data = res.data.map(r => ({
              sol:  r.Solution    || r.solution || r.SOLUTION || '',
              cr:   parseFloat(r.CR_restaurateurs) || parseFloat(r.CR) || 0,
              arch: parseFloat(r.Architecte)       || parseFloat(r.arch) || 0
            }));
            alert(`CSV chargé (${data.length} lignes).`);
          },
          error: err => alert('Erreur CSV : ' + err.message)
        });
      } else if (ext === 'xlsx' || ext === 'xls') {
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval: null });
        data = raw.map(r => ({
          sol:  r.Solution    || r.solution || r.SOLUTION || '',
          cr:   parseFloat(r.CR_restaurateurs) || parseFloat(r.CR) || 0,
          arch: parseFloat(r.Architecte)       || parseFloat(r.arch) || 0
        }));
        alert(`Excel chargé (${data.length} lignes).`);
      } else {
        alert('Format non supporté : CSV ou XLSX uniquement.');
      }
    });

    // 2) Calcul et affichage
    runBtn.addEventListener('click', () => {
      if (!data.length) {
        alert('Importez d’abord un fichier valide.');
        return;
      }

      // Lecture du scénario choisi
      const [wCR, wArch] = document.getElementById('scenario')
        .value.split(',').map(parseFloat);

      // Calcul du score pondéré
      const results = data.map(d => ({
        sol:   d.sol,
        score: d.cr * wCR + d.arch * wArch
      })).sort((a,b) => b.score - a.score);

      // Génération du tableau HTML
      let html = '<h2>Classement</h2>'
               + '<table><thead><tr>'
               + '<th>Solution</th><th>Score</th><th>Rang</th>'
               + '</tr></thead><tbody>';
      results.forEach((r,i) => {
        html += `<tr>
                   <td>${r.sol}</td>
                   <td>${r.score.toFixed(3)}</td>
                   <td>${i+1}</td>
                 </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('result').innerHTML = html;

      // Affichage du graphique
      new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
          labels: results.map(r => r.sol),
          datasets: [{ label: 'Score pondéré', data: results.map(r=>r.score) }]
        },
        options: { responsive: true }
      });
    });
  </script>

</body>
</html>
