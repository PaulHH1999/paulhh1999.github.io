<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Scénarios TOPSIS – CR vs Architecte</title>

  <!-- Librairies externes -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    .control { margin: 10px 0; }
    textarea { width: 100%; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    select, button, input { margin-left: 10px; }
    #chart { max-width: 600px; margin-top: 30px; }
  </style>
</head>
<body>

  <h1>⚖️ Classement selon scénario d’influence</h1>

  <!-- 1) Upload CSV ou XLSX -->
  <div class="control">
    <label for="csvFile">Charger un fichier (.csv/.xlsx) :</label>
    <input type="file" id="csvFile" accept=".csv,.xlsx,.xls">
  </div>

  <!-- 2) Coller du CSV directement -->
  <div class="control">
    <label for="csvText">Ou coller vos données CSV :</label><br>
    <textarea id="csvText" rows="6" placeholder="Solution;CR_restaurateurs;Architecte\nS1;0.62;0.54\n…"></textarea><br>
    <button id="useText">▶ Charger depuis la zone de texte</button>
  </div>

  <!-- 3) Choix du scénario -->
  <div class="control">
    <label for="scenario">Choisir le scénario :</label>
    <select id="scenario">
      <option value="0.25,0.75">CR 25 % – Arch 75 %</option>
      <option value="0.50,0.50" selected>CR 50 % – Arch 50 %</option>
      <option value="0.75,0.25">CR 75 % – Arch 25 %</option>
    </select>
    <button id="runBtn">▶ Calculer</button>
  </div>

  <!-- 4) Résultats -->
  <div id="result"></div>
  <canvas id="chart"></canvas>

  <script>
    const fileInput = document.getElementById('csvFile'),
          useText   = document.getElementById('useText'),
          runBtn    = document.getElementById('runBtn');
    let data = [];

    // Fonction de parsing générique
    function parseData(rawRows) {
      data = rawRows.map(r => ({
        sol:   r.Solution    || r.solution || r.SOLUTION || '',
        cr:    parseFloat(r.CR_restaurateurs) || parseFloat(r.CR) || 0,
        arch:  parseFloat(r.Architecte)       || parseFloat(r.arch) || 0
      }));
      alert(`Données chargées (${data.length} lignes).`);
    }

    // 1) Upload Fichier
    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const ext = file.name.split('.').pop().toLowerCase();

      if (ext === 'csv') {
        Papa.parse(file, {
          header: true, delimiter: ";",
          dynamicTyping: true, skipEmptyLines: true,
          complete: res => parseData(res.data),
          error: err => alert('Erreur CSV : ' + err.message)
        });
      }
      else if (ext === 'xlsx' || ext === 'xls') {
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval: null });
        parseData(raw);
      }
      else alert('Format non supporté : CSV ou XLSX uniquement.');
    });

    // 2) Charger depuis la zone de texte
    useText.addEventListener('click', () => {
      const txt = document.getElementById('csvText').value;
      if (!txt.trim()) return alert('Collez d’abord des données CSV.');
      Papa.parse(txt, {
        header: true, delimiter: ";",
        dynamicTyping: true, skipEmptyLines: true,
        complete: res => parseData(res.data),
        error: err => alert('Erreur CSV : ' + err.message)
      });
    });

    // 3) Calculer et afficher
    runBtn.addEventListener('click', () => {
      if (!data.length) return alert('Importez ou collez d’abord vos données.');

      const [wCR, wArch] = document.getElementById('scenario')
        .value.split(',').map(parseFloat);

      const results = data
        .map(d => ({ sol: d.sol, score: d.cr*wCR + d.arch*wArch }))
        .sort((a,b) => b.score - a.score);

      // Tableau
      let html = '<h2>Classement</h2>'
               + '<table><thead><tr>'
               + '<th>Solution</th><th>Score</th><th>Rang</th>'
               + '</tr></thead><tbody>';
      results.forEach((r,i) => {
        html += `<tr>
                   <td>${r.sol}</td>
                   <td>${r.score.toFixed(3)}</td>
                   <td>${i+1}</td>
                 </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('result').innerHTML = html;

      // Graphique
      new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
          labels: results.map(r => r.sol),
          datasets: [{ label: 'Score pondéré', data: results.map(r=>r.score) }]
        },
        options: { responsive: true }
      });
    });
  </script>

</body>
</html>
